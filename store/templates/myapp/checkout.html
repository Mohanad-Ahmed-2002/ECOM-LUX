{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Checkout - LUXEFLEX{% endblock %}

{% block content %}

{% for message in messages %}
<div class="alert alert-{{ message.tags }}">
    {{ message }}
</div>
{% endfor %}

<section class="container mx-auto px-4 py-12">
    <h1
        class="text-4xl font-extrabold text-center text-blue-800 mb-12 tracking-wide animate__animated animate__fadeInDown">
        Checkout
    </h1>

    <div class="bg-white shadow-xl rounded-2xl p-6 md:p-10 max-w-4xl mx-auto">
        <h2 class="text-xl font-semibold text-gray-800 mb-6">Your Order</h2>

        <!-- Cart Items Summary -->
        <div class="space-y-4 mb-8">
            {% for item in cart_items %}
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-xl shadow-sm">
                <div>
                    <p class="font-medium">{{ item.product.name }}</p>
                    <p class="text-sm text-gray-500">Quantity: {{ item.quantity }}</p>
                </div>
                <p class="font-bold text-blue-700">EGP {{ item.total_price }}</p>
            </div>
            {% endfor %}
        </div>

        <!-- Instapay Payment Info Card -->
        <div class="relative bg-white border border-blue-200 text-center p-10 rounded-[2rem] shadow-xl mb-14 overflow-hidden">
            <div
                class="absolute -top-16 -left-16 w-48 h-48 bg-gradient-to-br from-blue-100 to-blue-300 rounded-full opacity-30 blur-3xl">
            </div>
        
            <div class="mb-6">
                <div class="mx-auto w-16 h-16 bg-white rounded-full shadow-md flex items-center justify-center overflow-hidden">
                    <img src="/static/instapay.png" alt="Instapay Logo" class="w-full">
                </div>
                <h3 class="mt-4 text-2xl font-extrabold text-blue-800 tracking-wide">Instapay ðŸ’³</h3>
            </div>
        
            <p class="text-base text-gray-700 mb-2">
                You can transfer the amount to
                <span class="font-semibold text-blue-700">01012345678</span> using the Instapay app.
            </p>

        </div>




        <!-- Form -->
        <form method="POST" class="grid gap-6 md:grid-cols-2">
            {% csrf_token %}
            <div class="col-span-full">
                <label class="font-semibold">Name</label>
                {{ form.name|add_class:"w-full border border-gray-300 rounded-lg px-4 py-2" }}
            </div>

            <div>
                <label class="font-semibold">Email</label>
                {{ form.email|add_class:"w-full border border-gray-300 rounded-lg px-4 py-2" }}
            </div>

            <div>
                <label class="font-semibold">Phone</label>
                {{ form.phone|add_class:"w-full border border-gray-300 rounded-lg px-4 py-2" }}
            </div>

            <div class="col-span-full">
                <label class="font-semibold">Address</label>
                {{ form.address|add_class:"w-full border border-gray-300 rounded-lg px-4 py-2" }}
            </div>

            <div class="col-span-full">
                <label class="font-semibold">Governorate</label>
                <select name="government" id="government" onchange="updateTotals()"
                    class="w-full border border-gray-300 px-4 py-2 rounded-lg">
                    <option value="">Select Governorate</option>
                    {% for gov in governments %}
                    <option value="{{ gov.id }}" data-shipping-fee="{{ gov.shipping_fee }}">{{ gov.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-span-full space-y-2">
                <label for="promo_code" class="font-semibold">Promo Code:</label>
                <input type="text" name="promo_code" id="promo_code"
                    class="w-full border border-gray-300 p-2 rounded focus:outline-none focus:ring focus:ring-black">
            </div>

            <!-- Totals -->
            <div class="col-span-full bg-blue-50 p-4 rounded-lg space-y-2 text-sm text-gray-800 font-medium">
                <p>Subtotal: <span id="subtotal" class="float-right">EGP {{ subtotal }}</span></p>
                <p>Shipping: <span id="shipping" class="float-right">EGP {{ shipping_fee }}</span></p>
                <p id="discount" class="text-lg font-semibold text-green-700 hidden"></p>
                <hr>
                <p class="text-lg font-bold">Total: <span id="total" class="float-right text-blue-700">EGP {{
                        grand_total }}</span></p>
            </div>

            <div class="col-span-full flex justify-end">
                <button type="submit"
                    onclick="this.disabled = true; this.innerHTML = '<i class=\'fas fa-spinner fa-spin mr-2\'></i> Processing...'; this.form.submit();"
                    class="bg-blue-700 hover:bg-blue-800 text-white px-8 py-3 rounded-2xl font-bold text-lg shadow-md transition-all w-full text-center">
                    Confirm Order
                </button>

            </div>
        </form>
    </div>
</section>

<script>
    function updateTotals() {
        const govSelect = document.getElementById('government');
        const selected = govSelect.options[govSelect.selectedIndex];
        let shippingFee = parseFloat(selected.getAttribute('data-shipping-fee')) || 0;
        let subtotal = parseFloat("{{ subtotal }}") || 0;
        let discount = parseFloat(document.getElementById('discount')?.dataset.amount || 0);
        let total = subtotal - discount + shippingFee;

        document.getElementById('shipping').innerText = 'LE ' + shippingFee.toFixed(2);
        document.getElementById('total').innerText = 'LE ' + total.toFixed(2);
    }

    document.getElementById('promo_code').addEventListener('input', function () {
        const promoCode = this.value;
        const subtotal = parseFloat("{{ subtotal }}");

        if (promoCode.length > 1) {
            fetch(`/validate-promo/?code=${promoCode}&subtotal=${subtotal}`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('promo-msg')?.remove();
                    const discountElem = document.getElementById('discount');

                    if (data.valid) {
                        discountElem.innerHTML = `Discount: <span class="font-bold">- LE ${data.discount.toFixed(2)}</span>`;
                        discountElem.dataset.amount = data.discount;
                        discountElem.classList.remove('hidden');
                        updateTotals();
                    } else {
                        discountElem.classList.add('hidden');
                        const msg = document.createElement('p');
                        msg.id = 'promo-msg';
                        msg.className = 'text-sm text-red-600 font-semibold mt-1';
                        msg.innerText = data.message || 'Invalid promo code';
                        document.getElementById('promo_code').after(msg);
                    }
                });
        } else {
            document.getElementById('discount').classList.add('hidden');
            document.getElementById('promo-msg')?.remove();
            updateTotals();
        }
    });

    window.onload = updateTotals;
</script>

{% endblock %}